# 业务逻辑的实现

---

- 公文流转业务逻辑


## 教材业务逻辑

- 添加教材 (同一教材添加过一次后，不能重复添加)

::: tip
1.教材名称

2.出版社名称

3.作者

4.版别

5.选择课程 (教材和课程绑定)

6.教材类型  专业教材  通用教材  选读教材

7.采购价(选填)

8.学生生购买价(选填)

9.教材介绍 
     
:::


- 教材数据的计算 (实时计算)
::: tip

一年级的教材数量是根据下一年的预招计划的实招人数 + n%的浮动

二年级的教材数量是根据一年级在校人数 + n%的浮动

其他年级的教材以此类推 

教材是和课程绑定，查找该课有那些专业在读，查找该专业的当前学期的总人数就是在校人数

:::


- 查看某专业教材的采购情况
::: tip
 1.通过专业查看所有的课程
 
 2.查看该课程是哪年级的教程
 
 3.查看课程年级的下一级的班级 (查看班级:当前年份-教材的年级=班级的入学年份)
 
 4.在计算班级的学生总数 
  
    当课程的1年级的教材,应该参考已录取的学生数和计划招生数返回
:::


- 学生领书流程
::: tip
 学生是否可以领书与学费是否交清相关
 
 当老师让学生领书，通过学生的缴费情况下载领书凭条,通过凭条去领书
 
 当领完书后,老师通过平台可以批量修改该学生是否领到教材
:::

## 上传Excel 后台处理逻辑

### 1: 保存文件

### 2: 读取文件头

### 3: 根据预定义的字典, 定位出所有需要的列

### 4: 定位出文件中, 学生数据部分的起始行

### 5: 计算出一共有多少条数据在本次上传的文件中, 然后保存到数据库中. (上传时间, 文件归属, 数据类型, 行数, 列定位数据, 第一行数据的位置, 是否覆盖, 是否记录已存在的数据, 谁上传的)

### 6: 返回成功给前端, 提示已经放入执行队列, 等待导入了

### 7: 当队列执行到某条上传的文件记录, 从本地载入该文件; 利用工厂模式, 实例化相应的导入器对象

### 8: 组装成第一条数据的模型, 然后根据某关键字, 去数据库中查询, 是否存在该条数据
- 如果不存在, 进入添加流程
	- 逐个验证模型对象中的每一个数据, 是否符合预定义的验证逻辑

- 如果存在, 进入更新流程
	- 如果允许覆盖, 就逐个验证模型对象中的每一个数据, 是否符合预定义的验证逻辑. 通过了就更新, 没通过就保存起来
	- 如果不允许覆盖, 直接保存, 等待用户进一步指示

- 如何删除
	- 利用导入的编号, 将上次导入的全部删除, 从新添加即可

### 9: 循环直到最后一条数据处理完毕, 将结果保存到数据库表中, 发送消息, 通知上传的人
- 上传的人可以看到本次导入的详细结果
	- 成功导入多少条: 新增数据或者在允许覆盖的情况下更新的总数
	- 失败多少条: 失败原因
	- 等待进一步指示的有多少条

